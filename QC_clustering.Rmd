---
title: "Comparing results using different numbers of clusters and dispersion thresholds"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Quality-Control script to compare how..
1) a user-specified number of expression clusters (2, 3, or 4)

or

2) a user-specified threshold for miniumum dispersion (variance/mean of expression) a gene can exhibit to be considered to have expression plasticity

...influence which genes are called as diverging in plasticity between species.

```{r package-loading, include=FALSE}
sapply(c("WGCNA", "stringr", "ggplot2", "RColorBrewer", "ggpubr", "grid", "ComplexHeatmap", "circlize", "huxtable"), require, character.only=TRUE)
source("functions_for_figure_scripts.R")
load("data_files/QC_CorrelationClustering.RData")
load("data_files/FinalDataframe3Disp.RData")
clusterdf_list2 <- clusterdf_list
rm(clusterdf_list)
library(dplyr)
library(purrr)
```

## Comparing results with 2, 3, or 4 clusters

```{r clustdf}
# dataframe of nClust = 2, 3, and 4 clustering results
clustdf <- select(finaldf, gene_name, experiment, level, cer, par) |>
  dplyr::rename(c("cer2"="cer", "par2"="par", "gene_ID"="gene_name")) |>
  left_join(dplyr::rename(clusterdf3, c("cer3"="cer", "par3"="par")),
            by = c("gene_ID", "experiment")) |>
  left_join(dplyr::rename(clusterdf4, c("cer4"="cer", "par4"="par")),
            by = c("gene_ID", "experiment"))
```


```{r palette}
### Visualize cluster expression patterns in each experiment
display.brewer.all()
# color palettes we'll use for the 6 environments
palettedf <- tibble(experiment = ExperimentNames,
                    palette = c("Greys", "YlGn", "Greens", "Purples", "YlOrBr", "BuPu"),
                    long_name = LongExperimentNames)
```


```{r plotClusterPatternByExperiment}
plotClusterPatternByExperiment <- function(.df, .experiment, .title = NULL) {
  plotdf <- summarise(group_by(.df, time_point_num, label),
                      mean_expr = mean(expr, na.rm = TRUE))
  plotdf$label <- as.factor(plotdf$label)
  color_plt <- palettedf |> filter(experiment == .experiment) |> select(palette) |> pull()
  if (is.null(.title)) {
    .title <- palettedf |> filter(experiment == .experiment) |> select(long_name) |> pull()
  }
  ggplot(plotdf, aes(x = time_point_num, y = log2(mean_expr + 1))) +
    geom_line(aes(group = label, color = label), linewidth = 4) +
    geom_point(color = "black", alpha = 0.4) +
    xlab("timepoint (min)") +
    ylab("expression (log2)") +
    scale_color_brewer(palette = color_plt, name = "cluster",
                       direction = -1) +
    theme_classic() +
    theme(legend.position = "right") +
    ggtitle(.title)
}
```


```{r nclust-avg-expr-plots}
# 2 clusters
p <- ggarrange(plotClusterPatternByExperiment(clusterdf_list2$HAP4_2$df, .experiment = "HAP4"),
          plotClusterPatternByExperiment(clusterdf_list2$CC_2$df, .experiment = "CC"),
          plotClusterPatternByExperiment(clusterdf_list2$LowN_2$df, .experiment = "LowN"),
          plotClusterPatternByExperiment(clusterdf_list2$LowPi_2$df, .experiment = "LowPi"),
          plotClusterPatternByExperiment(clusterdf_list2$Heat_2$df, .experiment = "Heat"),
          plotClusterPatternByExperiment(clusterdf_list2$Cold_2$df, .experiment = "Cold"),
          nrow = 2, ncol = 3, common.legend = FALSE)
p
pdf("paper_figures/Supplement/cluster_ref_2.pdf",
    width = 8, height = 4)
p
dev.off()

# 3 clusters
p <- ggarrange(plotClusterPatternByExperiment(clusterdf_list3$HAP4_3$df, .experiment = "HAP4"),
          plotClusterPatternByExperiment(clusterdf_list3$CC_3$df, .experiment = "CC"),
          plotClusterPatternByExperiment(clusterdf_list3$LowN_3$df, .experiment = "LowN"),
          plotClusterPatternByExperiment(clusterdf_list3$LowPi_3$df, .experiment = "LowPi"),
          plotClusterPatternByExperiment(clusterdf_list3$Heat_3$df, .experiment = "Heat"),
          plotClusterPatternByExperiment(clusterdf_list3$Cold_3$df, .experiment = "Cold"),
          nrow = 2, ncol = 3, common.legend = FALSE)
p
pdf("paper_figures/Supplement/cluster_ref_3.pdf",
    width = 8, height = 4)
p
dev.off()

# 4 clusters
p <- ggarrange(plotClusterPatternByExperiment(clusterdf_list4$HAP4_4$df, .experiment = "HAP4"),
          plotClusterPatternByExperiment(clusterdf_list4$CC_4$df, .experiment = "CC"),
          plotClusterPatternByExperiment(clusterdf_list4$LowN_4$df, .experiment = "LowN"),
          plotClusterPatternByExperiment(clusterdf_list4$LowPi_4$df, .experiment = "LowPi"),
          plotClusterPatternByExperiment(clusterdf_list4$Heat_4$df, .experiment = "Heat"),
          plotClusterPatternByExperiment(clusterdf_list4$Cold_4$df, .experiment = "Cold"),
          nrow = 2, ncol = 3, common.legend = FALSE)
p
pdf("paper_figures/Supplement/cluster_ref_4.pdf",
    width = 8, height = 4)
p
dev.off()
```

### How does numbers of clusters affect which divergence group genes are in?

Given an experiment name, extracts the full matrix of nClust=2,3,4 x nGenes where each cell is the 4-group expression divergence category

```{r getClusterQCHeatmap}
getClusterQCHeatmap <- function(.e) {
  plot_cer <- clustdf |> filter(experiment == .e) |>
    pivot_longer(cols = c("cer2", "cer3", "cer4"),
                 names_to = "nclust", values_to = "cer") |>
    select(gene_ID, level, nclust, cer)
  plot_cer$nclust <- gsub("cer", "", plot_cer$nclust)
  plot_par <- clustdf |> filter(experiment == .e) |>
    pivot_longer(cols = c("par2", "par3", "par4"),
                 names_to = "nclust", values_to = "par") |>
    select(gene_ID, level, nclust, par)
  plot_par$nclust <- gsub("par", "", plot_par$nclust)

  plotdf <- full_join(plot_cer, plot_par,
                      by = c("gene_ID", "level", "nclust")) |>
    mutate(plasticity = if_else(cer == par,
                              true = "conserved",
                              false = "diverged"))
  plotdf$group4 <- map2(plotdf$level, plotdf$plasticity, \(l, d) {
    if (l != "diverged" & d == "conserved") {
      return("conserved level and plasticity")
    }
    if (l != "diverged" & d == "diverged") {
      return("conserved level, diverged plasticity")
    }
    if (l == "diverged" & d == "conserved") {
      return("diverged level, conserved plasticity")
    }
    if (l == "diverged" & d == "diverged") {
      return("diverged level and plasticity")
    }
  }) |> unlist()

  plot_mat_e <- plotdf |> select(gene_ID, nclust, group4) |>
    pivot_wider(id_cols = gene_ID, names_from = nclust,
                values_from = group4) |> t()
  colnames(plot_mat_e) <- plot_mat_e[1,]
  plot_mat_e <- plot_mat_e[-1,]
  ordered_plot_mat <- orderGenesByGroup(.mat = plot_mat_e)
  clrs <- structure(colordf[colordf$scheme == "group4",]$type,
                    names = colordf[colordf$scheme == "group4",]$limits)
  return(ordered_plot_mat)
}
# tests for getClusterQCHeatmap
test <- getClusterQCHeatmap(.e = "HAP4")
dim(test)
table(test[1,])
test0 <- test[, c(1:20, 2087:2107, 3092:3112, 3844:3864)]
```

Function to plot results:

```{r plotQCHeatmap}
# plots the 4-group expression divergence matrix as a heatmap
plotQCHeatmap <- function(.mat, .legend = FALSE) {
  .df <- bind_rows(tibble(gene_name = colnames(.mat),
                             nclust = 2,
                             group4 = .mat[1,],
                             x = c(1:ncol(.mat)),
                             y = 3),
                      tibble(gene_name = colnames(.mat),
                             nclust = 3,
                             group4 = .mat[2,],
                             x = c(1:ncol(.mat)),
                             y = 2),
                      tibble(gene_name = colnames(.mat),
                             nclust = 4,
                             group4 = .mat[3,],
                             x = c(1:ncol(.mat)),
                             y = 1))
  p <- ggplot(.df, aes(x = x, y = y, fill = group4)) +
    geom_tile_pattern(aes(fill = group4, pattern = group4), pattern_fill = "black") +
    scale_fill_discrete(limits = colordf[colordf$scheme == "group4",]$limits,
                        type = colordf[colordf$scheme == "group4",]$type) +
    scale_pattern_discrete(limits = colordf[colordf$scheme == "group4",]$limits,
                           choices = colordf[colordf$scheme == "group4",]$pattern) +
    theme_void()
  if (!.legend) {
    p <- p + theme(legend.position = "none")
  }
  if (.legend) {
    p <- p + theme(legend.position = "right")
  }
  return(p)
}
# tests for plotQCHeatmap
plotQCHeatmap(.mat = test0, .legend = TRUE)
```

```{r nclust-discrete-heatmaps, cache=TRUE}
# discrete heatmaps
for (e in ExperimentNames) {
  cat("working on", e, "\n")
  plot_mat_e <- getClusterQCHeatmap(.e = e)
  pdf(file = paste0("paper_figures/Supplement/nclust_heatmap_", e, ".pdf"),
      width = 9, height = 1)
  print(plotQCHeatmap(plot_mat_e))
  dev.off()
}
```


```{r nclust-percents}
### Percents of nClust=2 plasticity-divergers also labeled as plasticity-divergers
# in nClust=3
sum((clustdf$cer2 != clustdf$par2) & (clustdf$cer3 != clustdf$par3))/sum(clustdf$cer2 != clustdf$par2)
# in nClust=4
sum((clustdf$cer2 != clustdf$par2) & (clustdf$cer4 != clustdf$par4))/sum(clustdf$cer2 != clustdf$par2)

# The reverse: percents of nClust=3 or 4 plasticity-divergers
# also labeled as plasticity-divergers in nClust=2
# nClust=3
sum((clustdf$cer3 != clustdf$par3) & (clustdf$cer2 != clustdf$par2))/sum(clustdf$cer3 != clustdf$par3)
# nClust=4
sum((clustdf$cer4 != clustdf$par4) & (clustdf$cer2 != clustdf$par2))/sum(clustdf$cer4 != clustdf$par4)
```

Conclusion: nClust=2 is most conservative, a near perfect subset of nClust=3/4

## Comparing dispersion thresholds

```{r dispdf}
dispdf <- select(finaldf, gene_name, experiment, level, cer, par) |>
  dplyr::rename(c("cer3disp"="cer", "par3disp"="par", "gene_ID"="gene_name")) |>
  left_join(dplyr::rename(clusterdf_1disp, c("cer1disp"="cer", "par1disp"="par")),
            by = c("gene_ID", "experiment")) |>
  left_join(dplyr::rename(clusterdf_5disp, c("cer5disp"="cer", "par5disp"="par")),
            by = c("gene_ID", "experiment"))
```

```{r disp-avg-expr}
# dispersion = 3
p <- ggarrange(plotClusterPatternByExperiment(clusterdf_list2$HAP4_2$df, .experiment = "HAP4"),
          plotClusterPatternByExperiment(clusterdf_list2$CC_2$df, .experiment = "CC"),
          plotClusterPatternByExperiment(clusterdf_list2$LowN_2$df, .experiment = "LowN"),
          plotClusterPatternByExperiment(clusterdf_list2$LowPi_2$df, .experiment = "LowPi"),
          plotClusterPatternByExperiment(clusterdf_list2$Heat_2$df, .experiment = "Heat"),
          plotClusterPatternByExperiment(clusterdf_list2$Cold_2$df, .experiment = "Cold"),
          nrow = 2, ncol = 3, common.legend = FALSE)
p # (already plotted above)

# dispersion = 1
p <- ggarrange(plotClusterPatternByExperiment(clusterdf_list_1disp$HAP4_2$df, .experiment = "HAP4"),
          plotClusterPatternByExperiment(clusterdf_list_1disp$CC_2$df, .experiment = "CC"),
          plotClusterPatternByExperiment(clusterdf_list_1disp$LowN_2$df, .experiment = "LowN"),
          plotClusterPatternByExperiment(clusterdf_list_1disp$LowPi_2$df, .experiment = "LowPi"),
          plotClusterPatternByExperiment(clusterdf_list_1disp$Heat_2$df, .experiment = "Heat"),
          plotClusterPatternByExperiment(clusterdf_list_1disp$Cold_2$df, .experiment = "Cold"),
          nrow = 2, ncol = 3, common.legend = FALSE)
p
pdf("paper_figures/Supplement/cluster_ref_1disp.pdf",
    width = 8, height = 4)
p
dev.off()

# dispersion = 5
p <- ggarrange(plotClusterPatternByExperiment(clusterdf_list_5disp$HAP4_2$df, .experiment = "HAP4"),
          plotClusterPatternByExperiment(clusterdf_list_5disp$CC_2$df, .experiment = "CC"),
          plotClusterPatternByExperiment(clusterdf_list_5disp$LowN_2$df, .experiment = "LowN"),
          plotClusterPatternByExperiment(clusterdf_list_5disp$LowPi_2$df, .experiment = "LowPi"),
          plotClusterPatternByExperiment(clusterdf_list_5disp$Heat_2$df, .experiment = "Heat"),
          plotClusterPatternByExperiment(clusterdf_list_5disp$Cold_2$df, .experiment = "Cold"),
          nrow = 2, ncol = 3, common.legend = FALSE)
p
pdf("paper_figures/Supplement/cluster_ref_5disp.pdf",
    width = 8, height = 4)
p
dev.off()
```

```{r getDispersionQCHeatmap}
getDispersionQCHeatmap <- function(.e) {
  plot_cer <- dispdf |> filter(experiment == .e) |>
    pivot_longer(cols = c("cer3disp", "cer1disp", "cer5disp"),
                 names_to = "dispersion", values_to = "cer") |>
    select(gene_ID, level, dispersion, cer)
  plot_cer$dispersion <- gsub("cer", "", plot_cer$dispersion)
  plot_par <- dispdf |> filter(experiment == .e) |>
    pivot_longer(cols = c("par3disp", "par1disp", "par5disp"),
                 names_to = "dispersion", values_to = "par") |>
    select(gene_ID, level, dispersion, par)
  plot_par$dispersion <- gsub("par", "", plot_par$dispersion)

  plotdf <- full_join(plot_cer, plot_par,
                      by = c("gene_ID", "level", "dispersion")) |>
    mutate(plasticity = if_else(cer == par,
                              true = "conserved",
                              false = "diverged"))
  plotdf$group4 <- map2(plotdf$level, plotdf$plasticity, \(l, d) {
    if (l != "diverged" & d == "conserved") {
      return("conserved level and plasticity")
    }
    if (l != "diverged" & d == "diverged") {
      return("conserved level, diverged plasticity")
    }
    if (l == "diverged" & d == "conserved") {
      return("diverged level, conserved plasticity")
    }
    if (l == "diverged" & d == "diverged") {
      return("diverged level and plasticity")
    }
  }) |> unlist()

  plot_mat_e <- plotdf |> select(gene_ID, dispersion, group4) |>
    pivot_wider(id_cols = gene_ID, names_from = dispersion,
                values_from = group4) |> t()
  colnames(plot_mat_e) <- plot_mat_e[1,]
  plot_mat_e <- plot_mat_e[-1,]
  ordered_plot_mat <- orderGenesByGroup(.mat = plot_mat_e)
  clrs <- structure(colordf[colordf$scheme == "group4",]$type,
                    names = colordf[colordf$scheme == "group4",]$limits)
  return(ordered_plot_mat)
}
# tests for getClusterQCHeatmap
test <- getDispersionQCHeatmap(.e = "HAP4")
dim(test)
table(test[1,])
test0 <- test[, c(1:20, 2087:2107, 3092:3112, 3844:3864)]
```

```{r disp-discrete-heatmaps, cache=TRUE}
for (e in ExperimentNames) {
  cat("working on", e, "\n")
  plot_mat_e <- getDispersionQCHeatmap(.e = e)
  pdf(file = paste0("paper_figures/Supplement/dispersion_heatmap_", e, ".pdf"),
      width = 9, height = 1)
  print(plotQCHeatmap(plot_mat_e))
  dev.off()
}
```

## Are the sometimes-static genes an even sampling of diverged and conserved?

Are genes that are put in the static category in at least one species but only at 3 or 5 dispersion an even sampling of genes in the different divergence categories, or are they predominantly coming from certain groups?

Repeating the same heatmaps from the "Similar Proportions" figure, except now with three dispersion levels. Dispersion = 3 (main paper):

```{r sometimes-static-3disp}
plotdf <- finaldf |>
  group_by(experiment, cer, par) |> 
  summarise(n = n())
plotdf$long_experiment <- map(plotdf$experiment, \(e) {
  LongExperimentNames[which(ExperimentNames == e)]
}) |> factor(levels = LongExperimentNames)
plotdf$cer <- factor(plotdf$cer, levels = c("0", "1", "2"))
plotdf$par <- factor(plotdf$par, levels = c("2", "1", "0"))
plotdf$type <- map2(plotdf$cer, plotdf$par, \(x, y) {
  if (x == y) {
    if (x == 0 & y == 0) {
      return("conserved static")
    }
    return("conserved plastic")
  }
  if (x == 0) {
    return("Spar-unique")
  }
  if (y == 0) {
    return("Scer-unique")
  }
  else {
    return("reversal")
  }
}) |> unlist()
p <- ggplot(plotdf, aes(x = cer, y = par, fill = type)) +
  geom_tile() +
  geom_text(aes(label = n,
                color = grepl(pattern = "conserved", x = type))) +
  scale_color_discrete(limits = c(TRUE, FALSE),
                       type = c("grey40", "white")) +
  scale_fill_discrete(limits = colordf[colordf$scheme == "plasticity",]$limits,
                      type = colordf[colordf$scheme == "plasticity",]$type) +
   facet_wrap(~long_experiment) +
  theme_classic() +
  xlab("Scer plasticity cluster") +
  ylab("Spar plasticity cluster") +
  guides(fill=guide_legend(title="number of genes")) +
  theme(legend.position = "none")
pdf("paper_figures/Supplement/plasticity_counts_heatmap_3disp.pdf",
    width = 4, height = 3)
p
dev.off()
```

Dispersion = 1 (less likely to call a gene static than the main paper):

```{r sometimes-static-1disp}
finaldf_1disp <- select(finaldf, -cer, -par) |> 
  left_join(clusterdf_1disp, by = c("gene_name"="gene_ID", "experiment"))
plotdf <- finaldf_1disp |>
  group_by(experiment, cer, par) |> 
  summarise(n = n())
plotdf$long_experiment <- map(plotdf$experiment, \(e) {
  LongExperimentNames[which(ExperimentNames == e)]
}) |> factor(levels = LongExperimentNames)
plotdf$cer <- factor(plotdf$cer, levels = c("0", "1", "2"))
plotdf$par <- factor(plotdf$par, levels = c("2", "1", "0"))
plotdf$type <- map2(plotdf$cer, plotdf$par, \(x, y) {
  if (x == y) {
    if (x == 0 & y == 0) {
      return("conserved static")
    }
    return("conserved plastic")
  }
  if (x == 0) {
    return("Spar-unique")
  }
  if (y == 0) {
    return("Scer-unique")
  }
  else {
    return("reversal")
  }
}) |> unlist()
p <- ggplot(plotdf, aes(x = cer, y = par, fill = type)) +
  geom_tile() +
  geom_text(aes(label = n,
                color = grepl(pattern = "conserved", x = type))) +
  scale_color_discrete(limits = c(TRUE, FALSE),
                       type = c("grey40", "white")) +
  scale_fill_discrete(limits = colordf[colordf$scheme == "plasticity",]$limits,
                      type = colordf[colordf$scheme == "plasticity",]$type) +
   facet_wrap(~long_experiment) +
  theme_classic() +
  xlab("Scer plasticity cluster") +
  ylab("Spar plasticity cluster") +
  guides(fill=guide_legend(title="number of genes")) +
  theme(legend.position = "none")
pdf("paper_figures/Supplement/plasticity_counts_heatmap_1disp.pdf",
    width = 4, height = 3)
p
dev.off()
```
Dispersion = 5 (less likely to call a gene static than the main paper):

```{r sometimes-static-5disp}
finaldf_5disp <- select(finaldf, -cer, -par) |> 
  left_join(clusterdf_5disp, by = c("gene_name"="gene_ID", "experiment"))
plotdf <- finaldf_5disp |>
  group_by(experiment, cer, par) |> 
  summarise(n = n())
plotdf$long_experiment <- map(plotdf$experiment, \(e) {
  LongExperimentNames[which(ExperimentNames == e)]
}) |> factor(levels = LongExperimentNames)
plotdf$cer <- factor(plotdf$cer, levels = c("0", "1", "2"))
plotdf$par <- factor(plotdf$par, levels = c("2", "1", "0"))
plotdf$type <- map2(plotdf$cer, plotdf$par, \(x, y) {
  if (x == y) {
    if (x == 0 & y == 0) {
      return("conserved static")
    }
    return("conserved plastic")
  }
  if (x == 0) {
    return("Spar-unique")
  }
  if (y == 0) {
    return("Scer-unique")
  }
  else {
    return("reversal")
  }
}) |> unlist()
p <- ggplot(plotdf, aes(x = cer, y = par, fill = type)) +
  geom_tile() +
  geom_text(aes(label = n,
                color = grepl(pattern = "conserved", x = type))) +
  scale_color_discrete(limits = c(TRUE, FALSE),
                       type = c("grey40", "white")) +
  scale_fill_discrete(limits = colordf[colordf$scheme == "plasticity",]$limits,
                      type = colordf[colordf$scheme == "plasticity",]$type) +
   facet_wrap(~long_experiment) +
  theme_classic() +
  xlab("Scer plasticity cluster") +
  ylab("Spar plasticity cluster") +
  guides(fill=guide_legend(title="number of genes")) +
  theme(legend.position = "none")
pdf("paper_figures/Supplement/plasticity_counts_heatmap_5disp.pdf",
    width = 4, height = 3)
p
dev.off()
```

